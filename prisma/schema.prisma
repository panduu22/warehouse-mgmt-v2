datasource db {
  provider = "mongodb"
  url      = env("MONGODB_URI")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  email         String    @unique
  image         String?
  role          Role      @default(STAFF) // Global role, mostly for super-admin or fallback
  
  warehouseAccess WarehouseAccess[]
  createdWarehouses Warehouse[] @relation("WarehouseCreator")
  createdBills    Bill[]
  verifiedTrips   Trip[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Warehouse {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  location    String
  
  createdById String?      @db.ObjectId
  createdBy   User?        @relation("WarehouseCreator", fields: [createdById], references: [id])

  access      WarehouseAccess[]
  products    Product[]
  vehicles    Vehicle[]
  trips       Trip[]
  bills       Bill[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model WarehouseAccess {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  userId      String       @db.ObjectId
  warehouseId String       @db.ObjectId
  role        WarehouseRole
  status      AccessStatus @default(PENDING)

  user        User         @relation(fields: [userId], references: [id])
  warehouse   Warehouse    @relation(fields: [warehouseId], references: [id])

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([userId, warehouseId])
}

model Product {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  sku         String   @unique
  quantity    Int      @default(0)
  price       Float    @default(0)
  location    String?
  pack        String?
  flavour     String?
  mrp         Float?
  invoiceCost Float?
  salePrice   Float?   // Selling price to customers
  
  warehouseId String   @db.ObjectId
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Vehicle {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  number      String        @unique
  driverName  String
  status      VehicleStatus @default(AVAILABLE)

  warehouseId String        @db.ObjectId
  warehouse   Warehouse     @relation(fields: [warehouseId], references: [id])
  
  trips       Trip[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Trip {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  status      TripStatus @default(LOADED)
  startTime   DateTime   @default(now())
  endTime     DateTime?
  
  vehicleId   String     @db.ObjectId
  vehicle     Vehicle    @relation(fields: [vehicleId], references: [id])

  warehouseId String     @db.ObjectId
  warehouse   Warehouse  @relation(fields: [warehouseId], references: [id])

  verifiedBy  String?    @db.ObjectId
  verifier    User?      @relation(fields: [verifiedBy], references: [id])

  loadedItems TripItem[]
  
  bill        Bill?

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

type TripItem {
  productId   String   @db.ObjectId
  qtyLoaded   Int
  qtyReturned Int      @default(0)
}

model Bill {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  totalAmount Float
  generatedAt DateTime @default(now())

  tripId      String   @unique @db.ObjectId
  trip        Trip     @relation(fields: [tripId], references: [id])

  warehouseId String   @db.ObjectId
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  generatedBy String   @db.ObjectId
  generator   User     @relation(fields: [generatedBy], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum Role {
  ADMIN
  STAFF
}

enum WarehouseRole {
  WAREHOUSE_ADMIN
  STAFF
}

enum AccessStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VehicleStatus {
  AVAILABLE
  IN_TRANSIT
  MAINTENANCE
}

enum TripStatus {
  LOADED
  RETURNED
  VERIFIED
}
